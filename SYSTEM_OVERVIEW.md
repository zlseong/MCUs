# ğŸš— ì™„ì „í•œ ì‹œìŠ¤í…œ ê°œìš”

## ğŸ¯ ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway (Linux/Mac)                                        â”‚
â”‚  - vehicle_gateway (C++)                                    â”‚
â”‚  - HTTP/WebSocket/MQTT Client                               â”‚
â”‚  - OTA Controller                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ TLS 1.3 + PQC
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server (Python)                                            â”‚
â”‚  - mqtt_protocol (FastAPI)                                  â”‚
â”‚  - WebSocket/HTTP API                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ TLS 1.3 + PQC
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TC375 MCU (TriCore)                                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Stage 1 Bootloader (64 KB) [ë¶ˆë³€]            â”‚         â”‚
â”‚  â”‚ - Stage 2 ê²€ì¦ & ì„ íƒ                         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚         â–¼                   â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Stage 2A    â”‚     â”‚ Stage 2B    â”‚  [OTA ê°€ëŠ¥]           â”‚
â”‚  â”‚ 188 KB      â”‚     â”‚ 188 KB      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                   â”‚                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                         â”‚
â”‚    â–¼         â–¼         â–¼         â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”                       â”‚
â”‚  â”‚App â”‚   â”‚App â”‚   â”‚App â”‚   â”‚App â”‚  [OTA ê°€ëŠ¥]           â”‚
â”‚  â”‚ A  â”‚   â”‚ B  â”‚   â”‚ A  â”‚   â”‚ B  â”‚                       â”‚
â”‚  â”‚2.4Mâ”‚   â”‚2.4Mâ”‚   â”‚2.4Mâ”‚   â”‚2.4Mâ”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                             â”‚
â”‚  Application ê¸°ëŠ¥:                                          â”‚
â”‚  - UDS Handler (ISO 14229)                                 â”‚
â”‚  - OTA Manager (Stage 2 + App ì—…ë°ì´íŠ¸)                    â”‚
â”‚  - TLS Client (Gateway í†µì‹ )                               â”‚
â”‚  - CAN Gateway, Sensors, etc.                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ **3ê°€ì§€ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€**

### âœ… **1. UDS ë©”ì‹œì§€ êµ¬í˜„**

**íŒŒì¼:**
- `tc375_simulator/include/uds_handler.hpp`
- `tc375_simulator/src/uds_handler.cpp`

**ì£¼ìš” ì„œë¹„ìŠ¤:**
```cpp
0x10  Diagnostic Session Control
0x27  Security Access (Seed/Key)
0x34  Request Download (OTA ì‹œì‘)
0x36  Transfer Data (íŒì›¨ì–´ ì „ì†¡)
0x37  Request Transfer Exit
0x22  Read Data By ID
0x11  ECU Reset
```

**ì‚¬ìš© ì˜ˆì‹œ:**
```cpp
UdsHandler uds;
UdsMessage request = receiveFromGateway();
UdsResponse response = uds.handleRequest(request);
sendToGateway(response);
```

---

### âœ… **2. ì—ëŸ¬ í•¸ë“¤ë§ & ë¡¤ë°± ì„¤ê³„**

**íŒŒì¼:**
- `tc375_simulator/include/ota_manager.hpp`
- `tc375_simulator/src/ota_manager.cpp`

**3ë‹¨ê³„ Fail-safe:**

```
Level 1: Download ì‹¤íŒ¨
  â†’ rollback() â†’ ë‹¤ìš´ë¡œë“œ ì¤‘ë‹¨, ì´ì „ ìƒíƒœ ìœ ì§€

Level 2: Verification ì‹¤íŒ¨
  â†’ eraseBank(target) â†’ ì˜ëª»ëœ íŒì›¨ì–´ ì‚­ì œ

Level 3: Boot ì‹¤íŒ¨ (3íšŒ)
  â†’ autoRollback() â†’ ì´ì „ ë±…í¬ë¡œ ìë™ ì „í™˜
```

**íŠ¸ëœì­ì…˜ íŒ¨í„´:**
```cpp
OtaTransaction txn;
txn.begin();            // ì²´í¬í¬ì¸íŠ¸ ìƒì„±

if (download_success) {
    txn.commit();       // ë³€ê²½ í™•ì •
} else {
    txn.rollback();     // ì›ìƒë³µêµ¬
}
```

---

### âœ… **3. ë©”ëª¨ë¦¬ A/B ë¶„í• **

**íŒŒì¼:**
- `tc375_bootloader/common/boot_common.h` (ë©”ëª¨ë¦¬ ë§µ)
- `tc375_bootloader/stage1/stage1_linker.ld` (Stage 1 ë§ì»¤)
- `tc375_bootloader/stage2/stage2_linker.ld` (Stage 2 ë§ì»¤)

**ë©”ëª¨ë¦¬ êµ¬ì¡°:**

```c
// Stage 1 (ë¶ˆë³€)
0x80000000 - 0x8000FFFF   (64 KB)

// Stage 2A/B (OTA ê°€ëŠ¥)
0x80011000 - 0x8003FFFF   (188 KB) Stage 2A
0x80041000 - 0x8006FFFF   (188 KB) Stage 2B

// Application A/B (OTA ê°€ëŠ¥)
0x80071000 - 0x802F0FFF   (2.4 MB) App A
0x802F2000 - 0x80571FFF   (2.4 MB) App B
```

**ë±…í¬ ì „í™˜:**
```cpp
// EEPROMì— ì €ì¥
BootConfig cfg;
cfg.stage2_active = B;  // Stage 2B ì„ íƒ
cfg.app_active = B;     // App B ì„ íƒ

// Reboot â†’ ìƒˆ ë±…í¬ì—ì„œ ë¶€íŒ…!
```

---

## ğŸŠ **ìƒì„±ëœ íŒŒì¼ë“¤ (MCUs í”„ë¡œì íŠ¸)**

```
MCUs/
â”œâ”€â”€ tc375_bootloader/
â”‚   â”œâ”€â”€ README.md                      âœ… ë¶€íŠ¸ë¡œë” ê°œìš”
â”‚   â”œâ”€â”€ build_bootloader.sh            âœ… ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ boot_common.h              âœ… ê³µí†µ ì •ì˜
â”‚   â”œâ”€â”€ stage1/
â”‚   â”‚   â”œâ”€â”€ stage1_main.c              âœ… Stage 1 ì½”ë“œ
â”‚   â”‚   â””â”€â”€ stage1_linker.ld           âœ… ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸
â”‚   â””â”€â”€ stage2/
â”‚       â”œâ”€â”€ stage2_main.c              âœ… Stage 2 ì½”ë“œ
â”‚       â””â”€â”€ stage2_linker.ld           âœ… ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸
â”‚
â”œâ”€â”€ tc375_simulator/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ uds_handler.hpp            âœ… UDS êµ¬í˜„
â”‚   â”‚   â””â”€â”€ ota_manager.hpp            âœ… OTA + ë¡¤ë°±
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ uds_handler.cpp            âœ…
â”‚       â””â”€â”€ ota_manager.cpp            âœ…
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ dual_bootloader_ota.md         âœ… ì™„ì „í•œ OTA ê°€ì´ë“œ
    â”œâ”€â”€ firmware_architecture.md       âœ… UDS/ë¡¤ë°±/A-B ìƒì„¸
    â””â”€â”€ bootloader_implementation.md   âœ… êµ¬í˜„ ê°€ì´ë“œ
```

---

## ğŸ¯ **ë‹¹ì‹ ì˜ ì§ˆë¬¸ 3ê°œ - ëª¨ë‘ êµ¬í˜„ ì™„ë£Œ!**

### **1. UDS ë©”ì‹œì§€ âœ…**
- ISO 14229 í‘œì¤€ êµ¬í˜„
- ì§„ë‹¨, OTA, ë³´ì•ˆ ì ‘ê·¼
- Gateway â†” TC375 í†µì‹ 

### **2. ì—ëŸ¬ í•¸ë“¤ë§ & ë¡¤ë°± âœ…**
- 3ë‹¨ê³„ Fail-safe
- íŠ¸ëœì­ì…˜ íŒ¨í„´
- ìë™ ë³µêµ¬

### **3. A/B ë©”ëª¨ë¦¬ ë¶„í•  âœ…**
- Stage 2: A/B ë“€ì–¼
- Application: A/B ë“€ì–¼  
- ë¶€íŠ¸ë¡œë”ë„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥!

---

## ğŸ“Š **ìµœì¢… ì‹œìŠ¤í…œ ë¹„êµ**

```
ë‹¨ìˆœ êµ¬ì¡° (ì˜µì…˜ A):
  ë¶€íŠ¸ë¡œë” 1ê°œ â†’ App A/B
  
ë‹¹ì‹ ì˜ ì„ íƒ (ì˜µì…˜ B):
  Stage 1 â†’ Stage 2 A/B â†’ App A/B
  
ì¥ì :
âœ… ë¶€íŠ¸ë¡œë” ë²„ê·¸ ìˆ˜ì • ê°€ëŠ¥
âœ… PQC ì•Œê³ ë¦¬ì¦˜ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥
âœ… 3ë‹¨ê³„ ë¡¤ë°±
âœ… ìµœëŒ€ ì•ˆì „ì„±
```

---

## ğŸš€ **ë‹¤ìŒ ë‹¨ê³„:**

Gitì— ì»¤ë°‹í•˜ê³  í‘¸ì‹œí• ê¹Œìš”?

```bash
cd /Users/jiseong/Desktop/MCUs
git add -A
git commit -m "feat: Add 2-stage bootloader and OTA capabilities"
git push origin main
```

ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ‘
