# Bootloader Build Process ì„¤ëª…

## ì§ˆë¬¸: Common íŒŒì¼ì„ ë§ì»¤ë¥¼ í†µí•´ A/B ë©”ëª¨ë¦¬ì— ê°ê° ë„£ëŠ” ê±´ê°€?

**ë‹µ: ë§ìŠµë‹ˆë‹¤!**

## ë¹Œë“œ í”„ë¡œì„¸ìŠ¤

### 1. ì†ŒìŠ¤ ì½”ë“œ (Common)

**ë™ì¼í•œ ì½”ë“œ íŒŒì¼:**
```
tc375_bootloader/common/
â”œâ”€â”€ boot_common.h       # í—¤ë” (ì œì–´ ë¡œì§ ì •ì˜)
â”œâ”€â”€ boot_common.c       # êµ¬í˜„ (ê³µí†µ í•¨ìˆ˜)
â”œâ”€â”€ doip_client.h       # DoIP í´ë¼ì´ì–¸íŠ¸
â”œâ”€â”€ doip_client.c
â”œâ”€â”€ uds_handler.h       # UDS ì²˜ë¦¬
â””â”€â”€ uds_handler.c
```

**bootloader/ (ë©”ì¸ ì½”ë“œ):**
```
tc375_bootloader/bootloader/
â”œâ”€â”€ stage2_main.c       # Stage 2 ë©”ì¸ (ë™ì¼í•œ ì†ŒìŠ¤)
â”œâ”€â”€ stage2a_linker.ld   # A ë©”ëª¨ë¦¬ ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ stage2b_linker.ld   # B ë©”ëª¨ë¦¬ ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸
```

### 2. ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸ ì°¨ì´

#### Stage 2A Linker (0x800A1000)
```ld
MEMORY
{
    STAGE2_FLASH (rx) : ORIGIN = 0x800A1000, LENGTH = 196K  â† Region A
    STAGE2_RAM (rwx)  : ORIGIN = 0x70010000, LENGTH = 128K
}
```

#### Stage 2B Linker (0x820A1000)
```ld
MEMORY
{
    STAGE2_FLASH (rx) : ORIGIN = 0x820A1000, LENGTH = 196K  â† Region B
    STAGE2_RAM (rwx)  : ORIGIN = 0x70010000, LENGTH = 128K  â† RAM ê³µìœ 
}
```

**ì°¨ì´ì :**
- **FLASH ì£¼ì†Œë§Œ ë‹¤ë¦„** (A: 0x800A1000, B: 0x820A1000)
- **RAMì€ ë™ì¼** (ì‹¤í–‰ ì‹œ í•˜ë‚˜ë§Œ í™œì„±)
- **ì†ŒìŠ¤ ì½”ë“œëŠ” ì™„ì „íˆ ë™ì¼**

### 3. ë¹Œë“œ ëª…ë ¹

```bash
# Stage 2A ë¹Œë“œ (Region Aë¡œ ë§í¬)
tricore-gcc \
    -c bootloader/stage2_main.c \
    -c common/boot_common.c \
    -c common/doip_client.c \
    -c common/uds_handler.c \
    -T bootloader/stage2a_linker.ld \
    -o stage2a.elf

# Stage 2B ë¹Œë“œ (Region Bë¡œ ë§í¬)
tricore-gcc \
    -c bootloader/stage2_main.c \    # â† ë™ì¼í•œ ì†ŒìŠ¤!
    -c common/boot_common.c \         # â† ë™ì¼í•œ ì†ŒìŠ¤!
    -c common/doip_client.c \         # â† ë™ì¼í•œ ì†ŒìŠ¤!
    -c common/uds_handler.c \         # â† ë™ì¼í•œ ì†ŒìŠ¤!
    -T bootloader/stage2b_linker.ld \ # â† ë§ì»¤ë§Œ ë‹¤ë¦„!
    -o stage2b.elf
```

### 4. ê²°ê³¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TC375 PFLASH (6 MB)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Region A (0x80000000 - 0x81FFFFFF)                â”‚
â”‚  â”œâ”€ 0x800A1000  Stage 2A â† stage2a.elf           â”‚
â”‚  â”‚   (ë™ì¼í•œ ì½”ë“œ, Region A ì£¼ì†Œë¡œ ë¹Œë“œë¨)          â”‚
â”‚  â””â”€ 0x800D3000  Application A                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Region B (0x82000000 - 0x83FFFFFF)                â”‚
â”‚  â”œâ”€ 0x820A1000  Stage 2B â† stage2b.elf           â”‚
â”‚  â”‚   (ë™ì¼í•œ ì½”ë“œ, Region B ì£¼ì†Œë¡œ ë¹Œë“œë¨)          â”‚
â”‚  â””â”€ 0x820D3000  Application B                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## í•µì‹¬ ê°œë…

### âœ… ë™ì¼í•œ ê²ƒ
- **ì†ŒìŠ¤ ì½”ë“œ íŒŒì¼** (stage2_main.c, boot_common.c ë“±)
- **ê¸°ëŠ¥ ë¡œì§** (ê²€ì¦, ì í”„, OTA ì²˜ë¦¬)
- **ì•Œê³ ë¦¬ì¦˜** (CRC32, Signature ê²€ì¦)

### âŒ ë‹¤ë¥¸ ê²ƒ
- **ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸** (stage2a_linker.ld vs stage2b_linker.ld)
- **ë°°ì¹˜ ì£¼ì†Œ** (Region A: 0x80... vs Region B: 0x82...)
- **ë°”ì´ë„ˆë¦¬ íŒŒì¼** (stage2a.elf vs stage2b.elf)

## ì™œ ì´ë ‡ê²Œ í•˜ëŠ”ê°€?

### 1. ì½”ë“œ ì¬ì‚¬ìš©
```c
// ë™ì¼í•œ ì†ŒìŠ¤ ì½”ë“œ
// common/boot_common.c
void verify_application(uint32_t addr) {
    // Region Aë“  Bë“  ë™ì¼í•œ ê²€ì¦ ë¡œì§
    BootMetadata* meta = (BootMetadata*)addr;
    if (meta->magic != MAGIC_NUMBER) return false;
    // ...
}
```

### 2. OTA ì•ˆì „ì„±
```
Active: Stage 2A (Region A)
Backup: Stage 2B (Region B) â† ë™ì¼í•œ ì½”ë“œ, ë‹¤ë¥¸ ìœ„ì¹˜

OTA ì—…ë°ì´íŠ¸:
1. Stage 2B ì—…ë°ì´íŠ¸ (Stage 2A ì‹¤í–‰ ì¤‘)
2. ê²€ì¦ í›„ Region Bë¡œ ì „í™˜
3. ì‹¤íŒ¨ ì‹œ Region Aë¡œ ë¡¤ë°±
```

### 3. ë©”ëª¨ë¦¬ íš¨ìœ¨
```
RAM (192 KB):
â”œâ”€ 0x70000000  SSW ì‚¬ìš© (4 KB)
â”œâ”€ 0x70010000  Stage 2 ì‚¬ìš© (128 KB) â† A/B ê³µìœ 
â””â”€ 0x70030000  Application ì‚¬ìš© (60 KB)

FLASH (6 MB):
â”œâ”€ Region A (3 MB) - Active
â””â”€ Region B (3 MB) - Backup
```

## ë¹Œë“œ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Source Files (Common)                   â”‚
â”‚  - stage2_main.c                                 â”‚
â”‚  - boot_common.c                                 â”‚
â”‚  - doip_client.c                                 â”‚
â”‚  - uds_handler.c                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚   Compile     â”‚ â”‚   Compile   â”‚        â”‚
        â”‚   stage2a     â”‚ â”‚   stage2b   â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
                â”‚                 â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚ Link with     â”‚ â”‚ Link with   â”‚        â”‚
        â”‚ stage2a_      â”‚ â”‚ stage2b_    â”‚        â”‚
        â”‚ linker.ld     â”‚ â”‚ linker.ld   â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
                â”‚                 â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚  stage2a.elf  â”‚ â”‚ stage2b.elf â”‚        â”‚
        â”‚  @ 0x800A1000 â”‚ â”‚ @ 0x820A1000â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
                â”‚                 â”‚                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚  Flash to     â”‚ â”‚ Flash to    â”‚        â”‚
        â”‚  Region A     â”‚ â”‚ Region B    â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”
â”‚              TC375 PFLASH                          â”‚
â”‚  Region A (0x80...)     Region B (0x82...)        â”‚
â”‚  â”œâ”€ Stage 2A (196KB)   â”œâ”€ Stage 2B (196KB)       â”‚
â”‚  â””â”€ App A (2.1MB)      â””â”€ App B (2.1MB)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Applicationë„ ë™ì¼

Applicationë„ ê°™ì€ ë°©ì‹:

```bash
# Application A ë¹Œë“œ
tricore-gcc \
    -c ecu_node.c \
    -c doip_client.c \
    -T app_a_linker.ld \  # Region A ë§ì»¤
    -o app_a.elf

# Application B ë¹Œë“œ
tricore-gcc \
    -c ecu_node.c \       # â† ë™ì¼í•œ ì†ŒìŠ¤!
    -c doip_client.c \    # â† ë™ì¼í•œ ì†ŒìŠ¤!
    -T app_b_linker.ld \  # â† ë§ì»¤ë§Œ ë‹¤ë¦„!
    -o app_b.elf
```

## ì‹¤ì œ ì˜ˆì œ

### Common íŒŒì¼ (boot_common.c)
```c
// ë™ì¼í•œ ì†ŒìŠ¤ ì½”ë“œ
#include "boot_common.h"

uint32_t calculate_crc32(const uint8_t* data, uint32_t length) {
    // CRC32 ê³„ì‚° (Region A/B ë¬´ê´€)
    uint32_t crc = 0xFFFFFFFF;
    for (uint32_t i = 0; i < length; i++) {
        crc ^= data[i];
        for (int j = 0; j < 8; j++) {
            crc = (crc >> 1) ^ ((crc & 1) ? 0xEDB88320 : 0);
        }
    }
    return ~crc;
}

bool verify_metadata(uint32_t addr) {
    BootMetadata* meta = (BootMetadata*)addr;
    return (meta->magic == MAGIC_NUMBER);
}
```

### Stage 2A Linker
```ld
MEMORY {
    STAGE2_FLASH : ORIGIN = 0x800A1000  â† Region A
}
```

### Stage 2B Linker
```ld
MEMORY {
    STAGE2_FLASH : ORIGIN = 0x820A1000  â† Region B
}
```

### ê²°ê³¼
```
Region A: 0x800A1000ì— calculate_crc32() ë°°ì¹˜
Region B: 0x820A1000ì— calculate_crc32() ë°°ì¹˜ (ë™ì¼í•œ ì½”ë“œ)
```

## ì •ë¦¬

### âœ… Common íŒŒì¼ì˜ ì—­í• 
- **ì œì–´ ë¡œì§ êµ¬í˜„** (boot_common.c, doip_client.c ë“±)
- **ë‘ ë²ˆ ë¹Œë“œë¨** (Region Aìš©, Region Bìš©)
- **ë§ì»¤ë§Œ ë‹¤ë¦„** (ë°°ì¹˜ ì£¼ì†Œë§Œ ë³€ê²½)

### ğŸ”§ ë§ì»¤ ìŠ¤í¬ë¦½íŠ¸ì˜ ì—­í• 
- **ë©”ëª¨ë¦¬ ì£¼ì†Œ ì§€ì •** (A: 0x80..., B: 0x82...)
- **RAM ì˜ì—­ ê³µìœ ** (ì‹¤í–‰ ì‹œ í•˜ë‚˜ë§Œ ì‚¬ìš©)
- **ë°”ì´ë„ˆë¦¬ ìµœì¢… ë°°ì¹˜**

### ğŸ“¦ ìµœì¢… ê²°ê³¼
```
ë™ì¼í•œ ì†ŒìŠ¤ â†’ ë‘ ê°œì˜ ë§ì»¤ â†’ ë‘ ê°œì˜ ë°”ì´ë„ˆë¦¬ â†’ A/B ë©”ëª¨ë¦¬
```

**ë„¤, ë§ìŠµë‹ˆë‹¤! ë™ì¼í•œ Common íŒŒì¼ì„ ë§ì»¤ë¥¼ í†µí•´ A ë©”ëª¨ë¦¬ì™€ B ë©”ëª¨ë¦¬ì— ê°ê° ë°°ì¹˜í•©ë‹ˆë‹¤!** âœ…

